<!DOCTYPE html>
<html>
<head>
  <title>Login Page</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div class="Login_container">
    <h2>Login</h2>
    <form id="loginForm">
      <input type="text" placeholder="Username" id="username" required>
      <input type="password" placeholder="Password" id="password" required>
      <button type="submit">Login</button>
    </form>
  </div>
  
<script>
let backupContent = null;
var totalAmount = 0;
var advanceAmount = 0;
var billNumber = "";
var serialNumber = 1;
var showPerUnitPrice = true;
var customerName = "";
var phoneNumber = "";
var changesMade = false;
var username = ""
var password = ""

 <!-- Call the functions to update the HTML content -->
 
 const loginForm = document.getElementById('loginForm');
    loginForm.addEventListener('submit', function(event) {
      event.preventDefault();
      username = document.getElementById('username').value;
      password = document.getElementById('password').value;
      
      // Check login credentials
      if (username === 'Jey' && password === 'jey') {
        sessionStorage.setItem('username', username);
        showLoggedInContent();
      } else {
        if (username !== 'Jey') {
          alert("Username is incorrect. Please enter the correct username.");
        } else {
          alert("Password is incorrect. Please enter the correct password.");
        }
      }
    });
    
// Add an event listener for the beforeunload event
// window.addEventListener('beforeunload', function (e) {
//  refreshPage()
// }); 

// Function to prompt the user to save the current bill
function promptToSave() {
  const shouldSave = window.confirm('Do you want to save your changes before refreshing?');
  if (shouldSave) {
     // Call your saveBill function
     saveBill();
  } else {
   
   // Leave this since Regresh page function will handle this part
  }
}

function refreshPage() {

     promptToSave()
  
            // Preserve the current URL (home page)
            var currentUrl = window.location.href;
            

            // Reload the current URL
            window.location.href = currentUrl;
        }

function showLoggedInContent() {

    // Retrieve the HTML code from the script tag
    const billingPageHtmlCode = document.getElementById('BillingPageHtmlCode').innerHTML;
    
    document.body.innerHTML = billingPageHtmlCode;
    
     // Initial population of bill history dropdown
    showBillHistory();
     document.getElementById("accountName").textContent = `Session UserName: ${username}`; 
    
    }
    

// Function to generate a random bill number (you can modify this logic as needed)
function generateBillNumber() {
  billNumber = Math.floor(Math.random() * 1000) + 1;
   document.getElementById("billNumber").textContent = `Bill Number: ` + billNumber; 
 
}

// Function to get the current date in the format: MM/DD/YYYY
function getCurrentDate() {
  const now = new Date();
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  const day = now.getDate().toString().padStart(2, '0');
  const year = now.getFullYear();
  return `${month}/${day}/${year}`;
}

function enterCustomerDetails() {
  document.getElementById("customerDetails").style.display = "block";
}

function submitCustomerDetails() {
  customerName = document.getElementById("customerNameInput").value;
  phoneNumber = document.getElementById("phoneNumberInput").value;

  // Display customer details above summary table
  document.getElementById("customerInfo").textContent = `Customer Name: ${customerName} | Phone Number: ${phoneNumber}`;
 document.getElementById("customerDetails").style.display = "none";
  
  var cashierName = document.getElementById("cashierName").value;
  document.getElementById("cashier").textContent = cashierName;
 
generateBillNumber(); 
 document.getElementById("currentDate").textContent = `Date: ` + getCurrentDate();
}

function addItem() {
  var itemName = document.getElementById("itemName").value;
  var itemQuantity = parseInt(document.getElementById("itemQuantity").value);
    var itemPrice = parseFloat(document.getElementById("itemPrice").value);

  if (itemName && !isNaN(itemQuantity) && !isNaN(itemPrice)) {
    var table = document.getElementById("itemTable");
    var row = table.insertRow(-1);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    
    var perUnitPrice = itemPrice / itemQuantity;

    cell1.innerHTML = serialNumber;
    cell2.innerHTML = itemName;
    cell3.innerHTML = itemQuantity;
    cell4.innerHTML = showPerUnitPrice ? "₹" + perUnitPrice.toFixed(2) : "";
    cell5.innerHTML = "₹" + itemPrice.toFixed(2);

    serialNumber++;
    document.getElementById("itemName").value = "";
    document.getElementById("itemQuantity").value = "";
    document.getElementById("itemPrice").value = "";
  } else {
    alert("Please enter valid item details.");
  }
  
}

function addAdvanceAmount() {
  var userAdvance = parseFloat(prompt("Enter Advance Amount:", "0.00"));
  if (!isNaN(userAdvance)) {
    advanceAmount = userAdvance;
    document.getElementById("advanceAmountDisplay").textContent = "(-) Advance Amount: ₹" + advanceAmount.toFixed(2);
  }
  
}

function togglePerUnitPrice() {
  showPerUnitPrice = document.getElementById("showPerUnitPrice").checked;
  document.getElementById("perUnitPriceHeader").style.display = showPerUnitPrice ? "table-cell" : "none";
  var perUnitPriceCells = document.querySelectorAll("#itemTable td:nth-child(4)");
  perUnitPriceCells.forEach(cell => {
    cell.style.display = showPerUnitPrice ? "table-cell" : "none";
  });
}

function removeItem() {
  var serialToRemove = parseInt(prompt("Enter Serial Number of the item to remove:"));
  if (!isNaN(serialToRemove)) {
    var table = document.getElementById("itemTable");
    var rows = table.getElementsByTagName("tr");
    for (var i = 1; i < rows.length; i++) {
      var row = rows[i];
      var serialCell = row.cells[0];
      var itemPriceCell = row.cells[4];
      var itemQuantity = parseInt(row.cells[2].innerHTML);
      var itemPrice = parseFloat(itemPriceCell.innerHTML.replace("$", ""));
      
      if (parseInt(serialCell.innerHTML) === serialToRemove) {
        totalAmount -= itemPrice * itemQuantity;
        document.getElementById("totalAmount").textContent = "₹" + totalAmount.toFixed(2);
        row.parentNode.removeChild(row);
        break;
      }
    }

    // Renumber the serial numbers
    for (var i = 1; i < rows.length; i++) {
      var row = rows[i];
      var serialCell = row.cells[0];
      serialCell.innerHTML = i;
    }
  } else {
    alert("Please enter a valid serial number.");
  }
  
}

function calculateTotal() {
  totalAmount = 0;
  var rows = document.querySelectorAll("#itemTable tr");
  for (var i = 1; i < rows.length; i++) {
    var row = rows[i];
    var itemPrice = parseFloat(row.cells[4].innerHTML.replace("₹", ""));
    totalAmount += itemPrice;
  }
  advanceAmount = document.getElementById("advanceAmountDisplay").textContent.replace("Advance Amount: ₹0.00","");
  totalAmount -= advanceAmount;
  document.getElementById("totalAmount").textContent = "₹" + totalAmount.toFixed(2);
}

function printSummary() {

  var printContents = document.querySelector(".container").innerHTML;
  var originalContents = document.body.innerHTML;

  // Add footer description
  var footerDescription = "<p>Thank you for shopping at Grocery Store!</p>";

  document.body.innerHTML = printContents + footerDescription;

  window.print();

  document.body.innerHTML = originalContents;
}

function saveAsPDF() {
  var printContents = document.querySelector(".container").innerHTML;

  // Create a new PDF document
  var doc = new jsPDF();
  
  // Add content to the PDF
  doc.html(printContents, {
    callback: function () {
      // Save the PDF
      if (typeof window.orientation !== "undefined") {
        // Mobile device
        var pdfBlob = doc.output("blob");
        var pdfUrl = URL.createObjectURL(pdfBlob);
        var a = document.createElement("a");
        a.style.display = "none";
        a.href = pdfUrl;
        a.download = "grocery_bill.pdf";
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(pdfUrl);
      } else {
        // Desktop/laptop device
        doc.save("grocery_bill.pdf");
      }
    }
  });
}

function saveBill() {
     
      const billId = `${customerName}-${billNumber}`;
      const fileName = prompt('Enter bill file name:', billId);
      if (!fileName) return;

      // Set the HTML content and save it as a bill
      const billContent = document.documentElement.outerHTML;
      localStorage.setItem(billId, billContent);

      // Refresh bill history dropdown
      showBillHistory();
    }

function showBillHistory() {
 
      const viewBillHistoryDropdown = document.getElementById('viewBillHistory');
      viewBillHistoryDropdown.innerHTML = '<option value="" disabled selected>View Bill History</option>'; // Clear previous content

      // Retrieve and display bill history from localStorage
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        viewBillHistoryDropdown.innerHTML += `<option value="${key}">${key}</option>`;
      }

      // Display the bill history dropdown
      viewBillHistoryDropdown.style.display = 'block';
    }

function viewSelectedBill() {
  const viewBillHistoryDropdown = document.getElementById('viewBillHistory');
  const selectedBillKey = viewBillHistoryDropdown.value;
  const printPreviewContent = document.getElementById('printPreviewContent');
  const printPreviewModal = document.getElementById('printPreviewModal');

  if (selectedBillKey) {
    const savedBillContent = localStorage.getItem(selectedBillKey);

    // Populate the print preview content with the saved bill details
    printPreviewContent.innerHTML = savedBillContent;

    // Show the modal overlay to display the hover page
    printPreviewModal.style.display = 'block';
  }
}

function viewSelectedBill_old() {
  const viewBillHistoryDropdown = document.getElementById('viewBillHistory');
  const selectedBillKey = viewBillHistoryDropdown.value;
  const detailedBillContent = document.getElementById('detailedBillContent');
  const detailedBill = document.getElementById('detailedBill');
  const backupContent = document.getElementById('backupContent');

  if (selectedBillKey) {
    // Backup the current content only if it hasn't been backed up yet
    if (!backupContent.hasAttribute('data-backup')) {
      backupContent.innerHTML = document.documentElement.outerHTML;
      backupContent.setAttribute('data-backup', 'true');
    }

    // Update the current content with the selected bill
    detailedBill.innerHTML = localStorage.getItem(selectedBillKey);
    detailedBillContent.style.display = 'block';
  } else {
    // Restore the original content if no bill is selected
    backupContent.removeAttribute('data-backup');
    detailedBillContent.style.display = 'none';
  }
}


function hideDetailedBill() {
      const backupContent = document.getElementById('backupContent');
      const detailedBillContent = document.getElementById('detailedBillContent');
      detailedBillContent.style.display = 'none';

      // Restore the previous content from backup
      if (backupContent.innerHTML) {
        document.documentElement.innerHTML = backupContent.innerHTML;
      } else {
        // Show the first screen (home page)
        showBillHistory();
      }
    }

function removeBill() {
      const viewBillHistoryDropdown = document.getElementById('viewBillHistory');
      const selectedBillKey = viewBillHistoryDropdown.value;

      if (selectedBillKey) {
        localStorage.removeItem(selectedBillKey);
        // hideDetailedBill();
        showBillHistory();
      }
    }

function showPrintPreview() {
  var currentBillContent = document.getElementById("printableDetails").innerHTML;
  var printPreviewContent = document.getElementById("printPreviewContent");

  // Set the content of the print preview
  printPreviewContent.innerHTML = "<h2>Current Bill Preview</h2>" + currentBillContent;

  // Show the modal overlay
  var printPreviewModal = document.getElementById("printPreviewModal");
  printPreviewModal.style.display = "block";
}

function closePrintPreview() {
  var printPreviewModal = document.getElementById("printPreviewModal");
  printPreviewModal.style.display = "none";
}

function printHoverPage_old() {
  var printPreviewContent = document.getElementById("printPreviewContent").innerHTML;
  var printWindow = window.open("", "Print Preview", "width=800,height=600");
  
  // Create the print content with header, content, and footer
  var printContent = `
    <html>
    <head>
      <title>Print Preview</title>
      <style>
        /* Add your existing CSS styles here */
        .print-header, .print-footer {
          text-align: center;
          margin: 10px 0;
        }
        .print-footer {
          font-style: italic;
        }
      </style>
    </head>
    <body>
      <div class="print-header">
        <h2>Random Shop Name</h2>
        <p>Shop Address</p>
      </div>
      ${printPreviewContent}
      <div class="print-footer">
        <p>Thank you for shopping at Random Shop!</p>
      </div>
    </body>
    </html>
  `;

  // Display the print content in the print preview window
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.focus();
}

function printHoverPage() {
  var printPreviewContent = document.getElementById("printPreviewContent").innerHTML;
  
  // Create a hidden element to hold the print content
  var printContainer = document.createElement("div");
  printContainer.style.display = "none";
  printContainer.innerHTML = `
    <style>
      /* Add your existing CSS styles here */
      .print-header, .print-footer {
        text-align: center;
        margin: 10px 0;
      }
      .print-footer {
        font-style: italic;
      }
    </style>
    <div class="print-header">
      <h2>Random Shop Name</h2>
      <p>Shop Address</p>
    </div>
    ${printPreviewContent}
    <div class="print-footer">
      <p>Thank you for shopping at Random Shop!</p>
    </div>
  `;

  // Append the hidden element to the document body
  document.body.appendChild(printContainer);

  // Print the hidden element's content
  window.print();

  // Remove the hidden element after printing
  document.body.removeChild(printContainer);
}


function onRefreshClick() {
            if (changesMade) {
                showSaveChangesDialog();
            } else {
                loadHomePageAfterRefresh();
            }
        }

function logout() {
      
      window.location.reload();
    }

</script>


<script id="BillingPageHtmlCode" type="text/html">
    <div id="backupContent" style="display: none;"></div>
    <div class="container">
  <div class="container_1">
    <div class="logo">
      <div class="jmart">JMart</div>
      <div class="store">store</div>
    </div>
    <div class="tagline">Your Fresh Grocery Destination</div>
   <!--  <div class="details">
      <div class="address">6/49, North Street, Elayirampannai</div>
      <div class="contact">Contact: 9944600814, 8667038973</div>
    </div>  -->
    </div>     
  
    <div class="custom-welcome-msg">
  Welcome to <span style="font-weight: bold;">JMart Stores</span>. We're glad to have you here!
  <div class="running-message">
    <div class="running-text">
      This week's Grocery App Maintenance Schedule: Monday 8:00 PM - 10:00 PM, Tuesday 7:30 PM - 9:30 PM, Thursday 6:00 PM - 8:00 PM. For more information, contact Jeyakrishnan at 9944600814.
    </div>
  </div>
</div>
<div class="signout">
<button Onclick="logout()">Logout</button>
</div>

<div id="accountName" class="session-name"></div>

  <div style="display: flex; gap: 10px;">
  <button onclick="enterCustomerDetails()">Enter Customer Details</button>
  
  <select id="viewBillHistory" onchange="viewSelectedBill()">
    <option value="" disabled selected>View Bill History</option>
  </select>
  <button id="refreshButton" onclick="refreshPage()">Refresh</button>
  </div>

  <div id="billHistoryContent" style="display: none;">
    <!-- Bill history content will be generated dynamically using JavaScript -->
  </div>
    
    <div id="BillHistoryBillContent" style="display: none;">
    <!-- Detailed bill content will be displayed here -->
    <h2>Detailed Bill</h2>
    <p id="detailedBill"></p>
    <button onclick="hideDetailedBill()">Back</button>
    <button onclick="removeBill()">Remove</button>
    </div>

  <div class="customer-details" id="customerDetails">
    <h3>Enter Customer Details</h3>
    <label for="customerName">Customer Name:</label>
    <input type="text" id="customerNameInput"><br>
    <label for="phoneNumber">Phone Number:</label>
    <input type="text" id="phoneNumberInput">
    <p>
        <label for="cashierName">Cashier Name:</label>
        <select id="cashierName">
          <option value="Jey">Jey</option>
          <option value="Krishna">Krishna</option>
          <option value="JK">JK</option>
          <!-- Add more names as needed -->
        </select>
      </p>
    
    <button onclick="submitCustomerDetails()">Submit</button>
  </div>

    <div class="items-input-container">
  <div class="items-input-box">
    <label for="itemName">Item Name:</label>
    <input type="text" id="itemName" placeholder="Enter item name">
  </div>
  
  <div class="items-input-box">
    <label for="itemQuantity">Item Quantity:</label>
    <input type="number" id="itemQuantity" placeholder="Enter quantity">
  </div>
  
  <div class="items-input-box">
    <label for="itemPrice">Item Price:</label>
    <input type="number" id="itemPrice" placeholder="Enter price">
  </div>

    <div style="display: flex; justify-content: center; margin-top: 20px;">
      <button onclick="addItem()">Add Item</button>
    </div>
    </div>
   <div id="printableDetails">
<h3>Bill Summary</h3>

  <div class="customer-details" id="customerDetails">
    <h3>Enter Customer Details</h3>
    <label for="customerName">Customer Name:</label>
    <input type="text" id="customerNameInput"><br>
    <label for="phoneNumber">Phone Number:</label>
    <input type="text" id="phoneNumberInput">
    <button onclick="submitCustomerDetails()">Submit</button>
  </div>
  
  <div id="billNumber" class="total" style="margin-top: 10px;"></div>
    
  <div id="currentDate" class="total" style="margin-top: 10px;"></div>

  <div id="customerInfo" class="total" style="margin-top: 10px;"></div>

  <table id="itemTable">
    <tr>
      <th>Serial Number</th>
      <th>Item Name</th>
      <th>Item Quantity</th>
      <th id="perUnitPriceHeader">Per Unit Price</th>
      <th>Item Price</th>
    </tr>
  </table>

  <p id="advanceAmountDisplay" class="total">(-) Advance Amount: ₹0.00</p>

  <p class="total">Total Amount: <span id="totalAmount">₹0.00</span></p>

  <p>Cashier: <span id="cashier"></span></p>
  
<div style="flex: 1; text-align: right;">
    <label for="showPerUnitPrice">Show Per Unit Price:</label>
    <input type="checkbox" id="showPerUnitPrice" checked onchange="togglePerUnitPrice()">
  </div>
  </div>
  
  <div class="buttons">
  <button class="add-advance-button" onclick="addAdvanceAmount()">Add Advance Amount</button>
  <button class="remove-item-button" onclick="removeItem()">Remove Item</button>
 <button class="calculate-total-button" onclick="calculateTotal()">Calculate Total Amount</button>
 
 <!-- <button class="print-pdf-button" onclick="saveAsPDF()">Save as PDF</button> -->
 <button class="print-preview-button" onclick="showPrintPreview()">Show Bill Preview</button>
  
  <button class="save-bill-button" id="saveBill" onclick="saveBill()">Save Bill</button>
  
  <button class="print-button" onclick="printSummary()">Print Page</button>
  
  </div>
  
  <div class="modal" id="printPreviewModal">
  <div class="modal-content">
    <span class="close" onclick="closePrintPreview()">&times;</span>
    <div class="print-header">
      <h2>JMart Stores</h2>
      <p>Elayirampannai</p>
    </div>
    <div id="printPreviewContent">
      <!-- Content of the print preview will be inserted here -->
    </div>
    <div class="print-footer">
      <p>Thank you for shopping at JMart Stores!</p>
    </div>
    <button class="print-button" onclick="printHoverPage()">Print</button>
  </div>
  </div>
</script>
</body>
</html>
